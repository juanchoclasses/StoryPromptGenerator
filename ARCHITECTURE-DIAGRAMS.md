# Architecture Diagrams

Visual representations of the Story Prompter architecture.

---

## 1. Storage Architecture (Current)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER ACTIONS                         â”‚
â”‚         (Create Book, Add Story, Generate Image, etc.)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         BUSINESS LOGIC LAYER             â”‚
        â”‚  (Components: SceneEditor, CastManager)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              SERVICE LAYER (API)                   â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ BookService  â”‚  â”‚ ImageGenerationService   â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚          â”‚                   â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚    â”‚                      â”‚
        â†“                     â†“    â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BookCache   â”‚    â”‚ ImageStorageServiceâ”‚  â”‚ImageGenerationAPIâ”‚
â”‚  (In-Memory) â”‚    â”‚                    â”‚  â”‚  (OpenRouter)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚
       â”‚                      â”‚
       â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ImageCache   â”‚    â”‚FileSystemService â”‚
â”‚ (In-Memory)  â”‚    â”‚   (File I/O)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                      â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    FILESYSTEM LAYER    â”‚
       â”‚                        â”‚
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
       â”‚  â”‚ ~/Documents/     â”‚  â”‚
       â”‚  â”‚ AI-Books/cache/  â”‚  â”‚
       â”‚  â”‚ prompter-cache/  â”‚  â”‚
       â”‚  â”‚                  â”‚  â”‚
       â”‚  â”‚  â”œâ”€ books/       â”‚  â”‚  Book JSON files
       â”‚  â”‚  â”œâ”€ images/      â”‚  â”‚  Scene images
       â”‚  â”‚  â”œâ”€ characters/  â”‚  â”‚  Character images
       â”‚  â”‚  â””â”€ metadata/    â”‚  â”‚  App metadata
       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Storage Layer Responsibilities

| Layer | Responsibility | Persistence |
|-------|---------------|-------------|
| **BookCache** | In-memory cache for books | Session only |
| **ImageCache** | In-memory cache for images | Session only |
| **BookService** | CRUD operations for books | Via BookCache |
| **ImageStorageService** | Image save/load | Via FileSystemService |
| **FileSystemService** | File I/O operations | Filesystem |
| **StorageService** | Legacy app data wrapper | Via BookCache |

### Data Flow: Save a Book

```
User clicks "Save"
    â†“
BookService.saveBook(book)
    â†“
BookCache.set(book)
    â”œâ”€ Update in-memory cache
    â””â”€ FileSystemService.writeJSON(bookId, bookData)
        â””â”€ Write to: ~/Documents/AI-Books/cache/prompter-cache/books/{bookId}.json
```

### Data Flow: Generate Character Image

```
User clicks "Generate" in Character Audition
    â†“
CharacterAuditionDialog.handleGenerate()
    â†“
CharacterImageService.generateCharacterImage()
    â”œâ”€ 1. Build prompt (CharacterImageService.buildCharacterPrompt)
    â”œâ”€ 2. Call API (ImageGenerationService.generateImage)
    â”‚      â””â”€ OpenRouter API (HTTP POST)
    â”œâ”€ 3. Store image (ImageStorageService.storeCharacterImage)
    â”‚      â””â”€ FileSystemService.writeImage()
    â”‚          â””â”€ Write to: ~/Documents/.../characters/{storyId}/{characterName}/{imageId}.png
    â””â”€ 4. Update character metadata
        â””â”€ character.imageGallery.push(newImage)
    â†“
CastManager.handleAuditionUpdate()
    â”œâ”€ Update character in book
    â””â”€ BookService.saveBook(book)
        â””â”€ (see "Save a Book" flow above)
```

---

## 2. Code Duplication Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DUPLICATION HOTSPOTS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. CHARACTER MANAGEMENT (70% overlap)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  CastManager.tsx    â”‚ â‰ˆâ‰ˆâ‰ˆâ‰ˆ â”‚ BookCastManager.tsx  â”‚
   â”‚  (Story-level)      â”‚ 70%  â”‚ (Book-level)         â”‚
   â”‚                     â”‚      â”‚                      â”‚
   â”‚  - Add character    â”‚      â”‚  - Add character     â”‚
   â”‚  - Edit character   â”‚      â”‚  - Edit character    â”‚
   â”‚  - Delete character â”‚      â”‚  - Delete character  â”‚
   â”‚  - Audition dialog  â”‚      â”‚  - Audition dialog   â”‚
   â”‚  - Save/load flows  â”‚      â”‚  - Save/load flows   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. DIAGRAM RENDERING (80% overlap)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ DiagramRenderer.ts  â”‚ â‰ˆâ‰ˆâ‰ˆâ‰ˆ â”‚ DiagramRenderService.ts  â”‚
   â”‚ (Standalone class)  â”‚ 80%  â”‚ (Service class)          â”‚
   â”‚                     â”‚      â”‚                          â”‚
   â”‚  - Mermaid support  â”‚      â”‚  - Mermaid support       â”‚
   â”‚  - Math (KaTeX)     â”‚      â”‚  - Math (KaTeX)          â”‚
   â”‚  - Code (highlight) â”‚      â”‚  - Code (highlight)      â”‚
   â”‚  - Canvas rendering â”‚      â”‚  - Canvas rendering      â”‚
   â”‚  - Style config     â”‚      â”‚  - Style config          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. PROMPT BUILDING (50% overlap)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚         SceneImageGenerationService.buildScenePrompt    â”‚
   â”‚                            â†“                            â”‚
   â”‚  - formatBookStyleForPrompt()                           â”‚
   â”‚  - Add book background                                  â”‚
   â”‚  - Add story background                                 â”‚
   â”‚  - Add character references                             â”‚
   â”‚  - Add scene description                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â‰ˆâ‰ˆâ‰ˆ 50% overlap
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚      CharacterImageService.buildCharacterPrompt         â”‚
   â”‚                            â†“                            â”‚
   â”‚  - formatBookStyleForPrompt()  â† SAME                   â”‚
   â”‚  - Add book background  â† SAME (different format)       â”‚
   â”‚  - Add story context  â† SAME                            â”‚
   â”‚  - Add character details                                â”‚
   â”‚  - Add white background instruction                     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. FILESYSTEM SERVICES (Platform-specific, acceptable)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ FileSystemService   â”‚ â‰ â‰ â‰   â”‚ElectronFileSystemService â”‚
   â”‚ (Browser)           â”‚      â”‚ (Electron)               â”‚
   â”‚                     â”‚      â”‚                          â”‚
   â”‚  - File Access API  â”‚      â”‚  - Electron IPC API      â”‚
   â”‚  - IndexedDB        â”‚      â”‚  - Node.js fs module     â”‚
   â”‚  920 lines          â”‚      â”‚  353 lines               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5. IMAGE URL CONVERSION (Small but repeated)
   - SceneImageGenerationService.blobUrlToDataUrl()
   - CharacterAuditionDialog (inline conversion)
   - Potentially more...
```

---

## 3. Component Size Visualization

```
Component Size Distribution (Lines of Code)

SceneEditor         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 2,400 ğŸš¨
OperationsPanel     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     2,164 ğŸš¨
StoriesPanel        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                     1,053 âš ï¸
CharacterAudition   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                          956 âš ï¸
SceneLayoutEditor   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                           885 âš ï¸
FileManager         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                            784
ExperimentPanel     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                             691
ImportStoryDialog   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                              585
BookStyleEditor     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                              578
SettingsDialog      â–ˆâ–ˆâ–ˆâ–ˆ                               507
CastManager         â–ˆâ–ˆâ–ˆâ–ˆ                               483
SceneList           â–ˆâ–ˆâ–ˆâ–ˆ                               458
BookCastManager     â–ˆâ–ˆâ–ˆâ–ˆ                               441
(Others < 450)      â–ˆâ–ˆâ–ˆ                               <450

Legend:
ğŸš¨ = Critical (>2000 lines, needs immediate refactoring)
âš ï¸ = Warning (>800 lines, consider splitting)
```

---

## 4. Test Coverage Heat Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TEST COVERAGE                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MODELS (3 files)
Book.ts             â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Story.ts            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Scene.ts            â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…

SERVICES (26 files)
BookCache           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
StorageService      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
SettingsService     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
DiagramService      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
LayoutResolver      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
ImageCache          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
TextMeasurement     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
MarkdownParser      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
PromptService       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…

BookService         â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ CRITICAL
FileSystemService   â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ CRITICAL
ImageStorageService â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ CRITICAL
SceneImageGen       â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ CRITICAL
BookExportImages    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ CRITICAL
CharacterImageSvc   â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ
ImageGenerationSvc  â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ
DiagramRenderer     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ
DiagramRenderSvc    â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ
OverlayService      â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ
(+8 more untested)

COMPONENTS (24 files)
ALL COMPONENTS      â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% âŒ CRITICAL

Overall Coverage: ~35% (excluding components)
Overall Coverage: ~18% (including components)
```

---

## 5. Dependency Graph (Simplified)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   SERVICE DEPENDENCIES                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ BookService  â”‚ (Main API)
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚           â”‚           â”‚
                â†“           â†“           â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚BookCache â”‚ â”‚ Storage â”‚ â”‚FileSystemâ”‚
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚ Service â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
               â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â†“
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ FileSystem  â”‚
                   â”‚   Service   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            IMAGE GENERATION DEPENDENCIES                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   SceneImageGenerationService            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚            â”‚               â”‚
     â†“            â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Image   â”‚ â”‚Character â”‚  â”‚   Overlay    â”‚
â”‚Generationâ”‚ â”‚ImageSvc  â”‚  â”‚   Service    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚               â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ImageStorageServiceâ”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ FileSystem   â”‚
            â”‚   Service    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Proposed Refactoring: CastManager

### Before (Current - Duplicated)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          CastManager.tsx (483 lines)                    â”‚
â”‚                                                         â”‚
â”‚  â”œâ”€ State Management (characters, dialogs, etc.)       â”‚
â”‚  â”œâ”€ Add Character Logic                                â”‚
â”‚  â”œâ”€ Edit Character Logic                               â”‚
â”‚  â”œâ”€ Delete Character Logic                             â”‚
â”‚  â”œâ”€ Audition Dialog Integration                        â”‚
â”‚  â”œâ”€ Save/Load from BookService                         â”‚
â”‚  â””â”€ UI Rendering (Accordions, Buttons, etc.)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        BookCastManager.tsx (441 lines)                  â”‚
â”‚                                                         â”‚
â”‚  â”œâ”€ State Management (characters, dialogs, etc.)  â†70% â”‚
â”‚  â”œâ”€ Add Character Logic                           â†70% â”‚
â”‚  â”œâ”€ Edit Character Logic                          â†70% â”‚
â”‚  â”œâ”€ Delete Character Logic                        â†70% â”‚
â”‚  â”œâ”€ Audition Dialog Integration                   â†70% â”‚
â”‚  â”œâ”€ Save/Load from BookService                    â†70% â”‚
â”‚  â”œâ”€ Promote/Demote Logic (UNIQUE)                      â”‚
â”‚  â””â”€ UI Rendering (Accordions, Buttons, etc.)      â†70% â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After (Proposed - Shared Hooks)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  hooks/useCharacterManager.ts (NEW)             â”‚
â”‚                                                  â”‚
â”‚  â”œâ”€ State: characters, editingCharacter         â”‚
â”‚  â”œâ”€ handleAdd()                                  â”‚
â”‚  â”œâ”€ handleEdit()                                 â”‚
â”‚  â”œâ”€ handleDelete()                               â”‚
â”‚  â”œâ”€ handleSave()                                 â”‚
â”‚  â””â”€ loadCharacters()                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘
                    â”‚ (uses)
                    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                â”‚
â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CastManager.tsx    â”‚   â”‚BookCastManager.tsx   â”‚
â”‚ (250 lines)        â”‚   â”‚ (280 lines)          â”‚
â”‚                    â”‚   â”‚                      â”‚
â”‚ â”œâ”€ useCharacter    â”‚   â”‚ â”œâ”€ useCharacter      â”‚
â”‚ â”‚  Manager()       â”‚   â”‚ â”‚  Manager()         â”‚
â”‚ â”œâ”€ useCharacter    â”‚   â”‚ â”œâ”€ useCharacter      â”‚
â”‚ â”‚  Audition()      â”‚   â”‚ â”‚  Audition()        â”‚
â”‚ â”œâ”€ Story-specific  â”‚   â”‚ â”œâ”€ Book-specific     â”‚
â”‚ â”‚  logic           â”‚   â”‚ â”‚  logic             â”‚
â”‚ â””â”€ UI rendering    â”‚   â”‚ â”œâ”€ Promote/Demote    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â””â”€ UI rendering      â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  hooks/useCharacterAudition.ts (NEW)             â”‚
â”‚                                                  â”‚
â”‚  â”œâ”€ State: auditionCharacter, dialogOpen        â”‚
â”‚  â”œâ”€ handleOpenAudition()                         â”‚
â”‚  â”œâ”€ handleCloseAudition()                        â”‚
â”‚  â”œâ”€ handleAuditionUpdate()                       â”‚
â”‚  â””â”€ Integration with CharacterImageService      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Benefits:**
- âœ… Eliminate 70% duplication
- âœ… Single source of truth for CRUD logic
- âœ… Easier to test (test hooks independently)
- âœ… Easier to maintain
- âœ… Can add new character managers easily

---

## 7. Proposed Refactoring: Prompt Building

### Current (Duplicated)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SceneImageGenerationService.buildScenePrompt()      â”‚
â”‚                                                      â”‚
â”‚  let prompt = '';                                    â”‚
â”‚  prompt += formatBookStyleForPrompt(book.style);     â”‚
â”‚  prompt += book.backgroundSetup;                     â”‚
â”‚  prompt += story.backgroundSetup;                    â”‚
â”‚  prompt += // character instructions                 â”‚
â”‚  prompt += // scene description                      â”‚
â”‚  return prompt;                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CharacterImageService.buildCharacterPrompt()        â”‚
â”‚                                                      â”‚
â”‚  let prompt = '';                                    â”‚
â”‚  prompt += formatBookStyleForPrompt(book.style);     â”‚
â”‚  prompt += 'Story Context: ' + storyBackground;      â”‚
â”‚  prompt += 'Character: ' + character.description;    â”‚
â”‚  prompt += // white background requirement           â”‚
â”‚  return prompt;                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Proposed (Unified)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         services/PromptBuilder.ts (NEW)              â”‚
â”‚                                                      â”‚
â”‚  class PromptBuilder {                               â”‚
â”‚    private sections: string[] = [];                  â”‚
â”‚                                                      â”‚
â”‚    addBookStyle(book: Book): this                    â”‚
â”‚    addBookBackground(book: Book): this               â”‚
â”‚    addStoryBackground(story: Story): this            â”‚
â”‚    addCharacterReferences(chars: Character[]): this  â”‚
â”‚    addInstructions(text: string): this               â”‚
â”‚    addSection(title: string, content: string): this  â”‚
â”‚    build(): string                                   â”‚
â”‚  }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†‘
                           â”‚ (uses)
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚SceneImageGeneration    â”‚   â”‚CharacterImageService  â”‚
â”‚Service                 â”‚   â”‚                       â”‚
â”‚                        â”‚   â”‚                       â”‚
â”‚ buildScenePrompt() {   â”‚   â”‚buildCharacterPrompt() â”‚
â”‚   return new           â”‚   â”‚  return new           â”‚
â”‚     PromptBuilder()    â”‚   â”‚    PromptBuilder()    â”‚
â”‚     .addBookStyle()    â”‚   â”‚    .addBookStyle()    â”‚
â”‚     .addBookBg()       â”‚   â”‚    .addStoryBg()      â”‚
â”‚     .addStoryBg()      â”‚   â”‚    .addSection(...)   â”‚
â”‚     .addCharacters()   â”‚   â”‚    .addInstructions() â”‚
â”‚     .addInstructions() â”‚   â”‚    .build();          â”‚
â”‚     .build();          â”‚   â”‚ }                     â”‚
â”‚ }                      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Benefits:**
- âœ… DRY (Don't Repeat Yourself)
- âœ… Consistent formatting
- âœ… Easy to test
- âœ… Flexible and extensible
- âœ… Centralized prompt logic

---

## 8. Testing Pyramid (Proposed)

```
                 â”Œâ”€â”€â”€â”€â”€â”€â”
                 â”‚  E2E â”‚  (Future)
                 â”‚Tests â”‚  Critical user journeys
                 â””â”€â”€â”€â”€â”€â”€â”˜  ~10 tests
                    â†‘
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚Integ.  â”‚   Save/load flows
               â”‚Tests   â”‚   Image generation
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Character auditions
                  â†‘         ~30 tests
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚Component  â”‚   User interactions
            â”‚  Tests    â”‚   Dialog flows
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Form validation
               â†‘            ~50 tests
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Service   â”‚     Business logic
        â”‚   Tests     â”‚     Data transformations
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     Error handling
              â†‘              ~100 tests
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    Unit      â”‚      Pure functions
       â”‚    Tests     â”‚      Utilities
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      Validators
                             ~150 tests

Current: ~40 tests (mostly unit + some service)
Target: ~340 tests (full pyramid)
```

---

**Diagrams Maintained By:** Architecture Team  
**Last Updated:** November 27, 2025

